<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title></title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="robots" content="all,follow">
    <!-- Bootstrap CSS-->
    <link rel="stylesheet" href="/static/vendor/bootstrap/css/bootstrap.min.css">
    <!-- Font Awesome CSS-->
    <link rel="stylesheet" href="/static/vendor/font-awesome/css/font-awesome.min.css">
    <!-- Fontastic Custom icon font-->
    <link rel="stylesheet" href="/static/css/fontastic.css">

    <!-- theme stylesheet-->
    <link rel="stylesheet" href="/static/css/style.default.css" id="theme-stylesheet">
    <!-- Custom stylesheet - for your changes-->
    <link rel="stylesheet" href="/static/css/custom.css">
    <!-- Favicon-->
    <link rel="shortcut icon" href="/static/img/favicon.ico">
    <style>
      .user-page{
        padding: 4px 10px;
        background-color: rgb(220,220,220);
        border-radius: 5px;
        border: 1px solid rgb(200,200,200);
        margin-right: 7px;
      }
      .page-now{
        background-color: white;
      }

    .hidden{
      display: none;
    }
    .could_span{
      top: 0;
      left: 0;
      position: fixed;
      z-index:100;
      background-color: rgba(110,110,110,0.65);
      width: 100%;
      height:100%;
    }
    .span_body{
      position: relative;
      width: 35%;
      background-color: white;
      border-radius: 10px;
      margin: 0 auto;
      top: 10px;
    }
    </style>
  </head>
  <body>
    <div class="page" id="app">
      <!-- Main Navbar-->
      <header class="header">
        <nav class="navbar">
          <!-- Search Box-->
          <div class="search-box">
            <button class="dismiss"><i class="icon-close"></i></button>
            <form id="searchForm" action="#" role="search">
              <input type="search" placeholder="What are you looking for..." class="form-control">
            </form>
          </div>
          <div class="container-fluid">
            <div class="navbar-holder d-flex align-items-center justify-content-between">
              <!-- Navbar Header-->
              <div class="navbar-header">
                <!-- Navbar Brand --><a href="index.html" class="navbar-brand d-none d-sm-inline-block">
                  <div class="brand-text d-none d-lg-inline-block"><strong>微云</strong><span>讲师后台 </span></div>
                  <div class="brand-text d-none d-sm-inline-block d-lg-none"><strong>BD</strong></div></a>
                <!-- Toggle Button--><a id="toggle-btn" href="#" class="menu-btn active"><span></span><span></span><span></span></a>
              </div>
              <!-- Navbar Menu -->
              <ul class="nav-menu list-unstyled d-flex flex-md-row align-items-md-center">
                <!-- Search-->
                <li class="nav-item d-flex align-items-center"><a id="search" href="#"><i class="icon-search"></i></a></li>
                <!-- Notifications-->

                <!-- Messages                        -->

                <!-- Languages dropdown    -->

                <!-- Logout    -->
                <li class="nav-item"><a href="#" @click="logout(event)" class="nav-link logout"> <span class="d-none d-sm-inline" >退出</span><i class="fa fa-sign-out"></i></a></li>
              </ul>
            </div>
          </div>
        </nav>
      </header>
      <div class="page-content d-flex align-items-stretch"> 
        <!-- Side Navbar -->
        <nav class="side-navbar">
          <!-- Sidebar Header-->
          <div class="sidebar-header d-flex align-items-center">
            <div class="avatar"><img :src="teacher['img']" alt="..." class="img-fluid rounded-circle"></div>
            <div class="title">
              <h1 class="h4">{{teacher["name"]}}</h1>
              <p>{{teacher["phone"]}}</p>
            </div>
          </div>
          <!-- Sidebar Navidation Menus--><span class="heading">Main</span>
          <ul class="list-unstyled">
            <li><a href="index.html"> <i class="icon-home"></i>主页</a></li>
            <li class="active"><a href="classManager.html"> <i class="icon-grid"></i>课程管理 </a></li>
            <li><a href="orderManager.html"> <i class="fa fa-bar-chart"></i>订单管理 </a></li>
            <li><a href="notify.html"> <i class="icon-mail"></i>消息通知</a></li>
            <li><a href="bill.html"> <i class="icon-padnote"></i>账单列表</a></li>
          </ul>
        </nav>
        <div class="content-inner">
          <!-- Page Header-->
          <header class="page-header">
            <div class="container-fluid">
              <h2 class="no-margin-bottom">课程管理</h2>
            </div>
          </header>
          <!-- Breadcrumb-->
          <div class="breadcrumb-holder container-fluid">
            <ul class="breadcrumb">
              <li class="breadcrumb-item active"><a href="index.html">主页</a> </li>
              <li class="breadcrumb-item active">课程管理</li>
            </ul>
          </div>
          <section class="tables">   
            <div class="container-fluid">
              <div class="row">

                <div class="col-lg-12">
                  <div class="card">

                    <div class="card-header d-flex align-items-center">
                      <h3 class="h4">课程列表</h3>
                    </div>
                    <div class="card-body">
                      <div class="table-responsive">  
                        <table class="table table-striped">
                          <thead>
                            <tr>
                              <th>序号</th>
                              <th>课程名称</th>
                              <th>类型</th>
                              <th>总章数</th>
                              <th>总节数</th>
                              <th>答疑交流</th>
                              <th>价格</th>
                              <th>是否收费</th>
                              <th>是否上架</th>
                              <th>是否被禁止上架</th>
                              <th>观看量</th>
                              <th>评分</th>
                              <th>操作</th>
                              <th>创建时间</th>
                            </tr>
                          </thead>
                          <tbody>
                            <tr v-for="(value,key) in classList">
                              <th scope="row">{{key+1+number}}</th>
                              <td><a :href="'/static/html/teacher/chapterTitle.html?classId='+value['id']+'&className='+value['name'] ">{{value["name"]}}</a> </td>
                              <td>{{value["typeName"]}}</td>
                              <td>{{value["chapterTitleCount"]}}</td>
                              <td>{{value["chapterCount"]}}</td>
                              <td><a :href="'/static/html/teacher/classComm.html?classId='+value.id">查看</a></td>
                              <td>{{value["price"]}}</td>
                              <td v-if="value.isCharge === 0">否</td>
                              <td v-else>是</td>
                              <td v-if="value.isShelves === 0">
                                否
                                <a href="#" @click="isShelvesHandle(event,1,value.id,key)">上架</a>
                              </td>
                              <td v-else>
                                是
                                <a href="#"  @click="isShelvesHandle(event,0,value.id,key)">下架</a>
                              </td>
                              <td>{{value["isBan"] === 1 ? '是' : '否'}}</td>
                              <td>{{value["watchCount"]}}</td>
                              <td>{{value["star"]}}</td>
                              <td>
                                <a href="#" @click="modify(key)">修改</a>&nbsp;&nbsp;
                                <a href="#" @click="delClass(key)">删除</a>
                              </td>
                              <td>{{value["createTime"] | date}}</td>
                            </tr>

                          </tbody>
                        </table>
                        <div style="text-align: center">
                                        <span v-for="(item,index) in pageList">
                                            <span class="user-page page-now" v-if="item.now">{{item.text}}</span>
                                             <a v-else class="user-page" @click="changePage(index,event)" href="#" >
                                                {{item.text}}
                                             </a>
                                        </span>

                        </div>
                        <p>
                          <div class="form-group" style="text-align: center">
                            <input type="button" @click="goToAddClass()" value="添加课程" class="btn btn-primary">
                          </div>
                        </p>
                      </div>

                    </div>
                  </div>
                </div>


              </div>
            </div>
          </section>
          <!-- Page Footer-->
          <footer class="main-footer">
            <div class="container-fluid">
              <div class="row">
                <div class="col-sm-6">
                  <p></p>
                </div>
                <div class="col-sm-6 text-right">
                  <p></p>
                  <!-- Please do not remove the backlink to us unless you support further theme's development at https://bootstrapious.com/donate. It is part of the license conditions. Thank you for understanding :)-->
                </div>
              </div>
            </div>
          </footer>
        </div>
      </div>

      <div class="could_span" :class="{'hidden':isSpanHidden}" @click="spanHidden()">
        <div class="span_body" @click="spanBodyClick(event)">

          <div class="card">
            <div class="card-header d-flex align-items-center">
              <h3 class="h4">修改课程信息</h3>
            </div>
            <div class="card-body" style="overflow:auto;height: 500px">
              <form>
                <div class="form-group">
                  <label class="form-control-label">章名</label>
                  <input v-model.trim="modifyContent.className"  class="form-control" style="width: 300px">
                </div>
                <div class="form-group">
                  <div>
                    <label class="form-control-label">类型</label>
                  </div>
                  <template v-for="item in typeList">
                    <input style="margin-left: 10px" type="radio" :id="'checkbox'+item.id" v-model.number="modifyContent.typeId" :value="item.id" ><label class="cloud_label" :for="'checkbox'+item.id">{{item.name}}</label>
                  </template>
                </div>
                <div class="form-group">
                  <label clbel="form-control-label">是否收费</label>
                  <input v-model.number="modifyContent.isCharge"  type="radio" style="margin-left: 10px" id="isCharge1" value="1"><label for="isCharge1">是</label>
                  <input v-model.number="modifyContent.isCharge"   type="radio" style="margin-left: 10px" id="isCharge2" value="0"><label for="isCharge2">否</label>
                </div>
                <div class="form-group">
                  <label class="form-control-label">是否上架</label>
                  <input v-model.number="modifyContent.isShelves"  type="radio" style="margin-left: 10px" id="isShelves1" value="1"><label for="isShelves1">是</label>
                  <input v-model.number="modifyContent.isShelves"   type="radio" style="margin-left: 10px" id="isShelves2" value="0"><label for="isShelves2">否</label>
                </div>
                <div class="form-group">
                  <label class="form-control-label">更改课程封面</label>
                  <div>
                    <input type="file"  id="fileUpload">
                  </div>
                </div>
                <div class="form-group">
                  <label class="form-control-label">课程封面预览</label>
                  <div>
                    <img id="picShow" style="width:170px;height:100px;" :src="modifyContent.picBase64"/>
                  </div>
                </div>
                <div class="form-group">
                  <label class="form-control-label">课程简介</label>
                  <div>
                    <textarea rows="4" placeholder="请输入课程简介" style="height:120px;width: 100%" v-model.trim="modifyContent.detail"></textarea>
                  </div>
                </div>

                <div class="form-group">
                  <input type="button" value="确定"  class="btn btn-primary" @click="modifySubmit()">
                </div>
              </form>
            </div>
          </div>

        </div>
      </div>
    </div>
    <!-- JavaScript files-->
    <script src="/static/vendor/jquery/jquery.min.js"></script>
    <script src="/static/vendor/popper.js/umd/popper.min.js"> </script>
    <script src="/static/vendor/bootstrap/js/bootstrap.min.js"></script>
    <script src="/static/vendor/jquery.cookie/jquery.cookie.js"> </script>
    <script src="/static/vendor/chart.js/Chart.min.js"></script>
    <script src="/static/vendor/jquery-validation/jquery.validate.min.js"></script>
    <!-- Main File-->
    <script src="/static/js/front.js"></script>
    <script src="/static/js/vue.js"></script>
    <script src="/static/js/axios.js"></script>
    <script>
      window.onload = function(){
        document.getElementById("fileUpload").addEventListener("change",picChange,false);
      };

      function picChange() {
        var file = this.files[0];
        if (!/image\/\w+/.test(file.type)) {
          alert("只能选择图片");
          return false;
        }
        var reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = function (e) {
          document.getElementById("picShow").src = this.result;
          vm.modifyContent.picBase64 = this.result;
          vm.modifyContent.picIsChange = 1
        }
      }

      var vm = new Vue({
        el:"#app",
        data:{
          number:0,
          pageList:[],
          classList:[],
          teacher:{
            name:null,
            phone:null,
            img:null
          },
          isSpanHidden:true,
          modifyContent:{
            className:"",
            typeName:"",
            typeId:0,
            isCharge:-1,
            isShelves:-1,
            id:0,
            key:-1,
            picBase64:null,
            detail:"",
            picIsChange:0
          },
          typeList:null,
        },
        mounted:function () {
          axios.get("/teacher/teacherGetClassList")
                  .then(function (res) {
                    console.log(res.data)
                    if(res.data.code === 1){
                      vm.classList = res.data.content.classList;
                      vm.pageList = res.data.content.page;
                    }else if(res.data.code === -2){
                      location.href = "/static/html/teacher/index.html"
                    }
                    vm.teacher = res.data.teacher;
                  }).catch(function (error) {
                    console.log(error)
          })
        },
        methods:{
          logout(e){
            e.preventDefault();
            httpGet({
              url:"/teacher/teacherLogout",
              success(res){
                location.href = "/static/html/teacher/login.html"
              },
              fail(){
                showError("退出失败")
              }
            })
          },
          spanHidden:function () {
            this.isSpanHidden = true;
            this.modifyContent.className = "";
            this.modifyContent.typeName = "";
            this.modifyContent.typeId = 0;
            this.modifyContent.isCharge = -1;
            this.modifyContent.isShelves = -1;
            this.modifyContent.key = -1;
            this.modifyContent.detail = "";
            this.modifyContent.picBase64 = null;
            this.modifyContent.picIsChange = 0;
            document.getElementById("picShow").src = null
          },
          spanBodyClick:function (e) {
            e.stopPropagation();
          },
          modify:function (key) {
            axios.get("/teacher/getTypeList").then(function (res) {
                      resHandler(res.data.code,function () {
                          console.log( res.data.content)
                        vm.typeList = res.data.content
                      })

                    }).catch(function (res) {

            });
            let c = this.classList[key];
            this.modifyContent.className = c.name;
            this.modifyContent.typeName = c.typeName;
            this.modifyContent.typeId = c.typeId;
            this.modifyContent.isCharge = c.isCharge;
            this.modifyContent.isShelves = c.isShelves;
            this.modifyContent.detail = c.detail;
            this.modifyContent.picBase64 = c.classImg;

            this.modifyContent.key = key;
            this.modifyContent.id = c.id;
            this.isSpanHidden = false
          },
          modifySubmit:function () {
            if(this.modifyContent.className === "" || this.modifyContent.typeId === 0 || this.modifyContent.isCharge === -1|| this.modifyContent.isShelves === -1 || this.modifyContent.id=== 1 || this.modifyContent.id === ""){
              showError("请填写完整信息");
              return;
            }
            let cla = this.classList[this.modifyContent.key];
            if(
                    this.modifyContent.className === cla.name &&
                    this.modifyContent.typeId === cla.typeId &&
                    this.modifyContent.isCharge === cla.isCharge &&
                    this.modifyContent.isShelves === cla.isShelves &&
                    this.modifyContent.detail === cla.detail && this.modifyContent.picBase64 === cla.classImg
            ){
              this.spanHidden();
              return;
            }
            let data;
            if(this.modifyContent.picIsChange === 1){
              data = {
                className:this.modifyContent.className,
                typeId:parseInt(this.modifyContent.typeId),
                isCharge:parseInt(this.modifyContent.isCharge),
                isShelves:parseInt(this.modifyContent.isShelves),
                id:parseInt(this.modifyContent.id),
                detail:this.modifyContent.detail,
                picBase64:this.modifyContent.picBase64,
              }
            }else{
              data = {
                className:this.modifyContent.className,
                typeId:parseInt(this.modifyContent.typeId),
                isCharge:parseInt(this.modifyContent.isCharge),
                isShelves:parseInt(this.modifyContent.isShelves),
                id:parseInt(this.modifyContent.id),
                detail:this.modifyContent.detail,
              }
            }

            axios.post("/teacher/modifyClass",data).then(function (res) {
              // console.log(res)
                resHandler(res.data.code)
            }).catch(function (res) {
              console.log(res)
            })
          },
          isShelvesHandle(e,status,classId,key){
            e.preventDefault();
            httpPost({
              url:"/teacher/updateIsShelves",
              data:{
                status:status,
                classId:classId
              },
              success(){
                vm.classList[key].isShelves = status
              },
              fail(res){
                console.log(res)
                showError("操作失败")
              }
            })
          },
          delClass:function (key) {
            let id = this.classList[key].id;
            axios.post("/teacher/delClass",{
              id:parseInt(id)
            }).then(function (res) {
              if (res.data.code === -1){
                showError(res.data.content)
              }else if(res.data.code === 1){
                location.reload()
              }else{
                resError()
              }
              // resHandler(res.data.code)
            }).catch(function (res) {
              console.log(res)
            })
          },
          goToAddClass(){
            location.href = "/static/html/teacher/addClass.html";
          },
          changePage(index,e){
            e.preventDefault();
            vm.number = vm.pageList[index].start;
            httpGet({
              url:"/teacher/teacherGetClassList?start="+vm.pageList[index].start,
              success(res){
                vm.classList = res.content.classList;
                vm.pageList =res.content.page;
              },
              fail(){
                vm.classList = [];
                vm.pageList = [];
              }
            });
            // alert(index);
          },
        },
        filters:{
          date(time){
            return date(time * 1000)
          }
        }
      })
    </script>
  </body>
</html>